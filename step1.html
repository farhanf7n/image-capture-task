<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Step - 1</title>

  <!-- Google fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />

  <!-- Custom css -->
  <link rel="stylesheet" href="style.css" />

  <!-- Bootstrap css  -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />

  <!-- Font awesome css  -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css" />

  <meta name="csrf-token" content="" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <script src="{{ asset('assets/js/jquery.validate.min.js') }}"></script>

  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #cameraContainer {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>

<body>
  <div id="loader">
    <div class="spinner"></div>
    <p>Loading..</p>
  </div>
  <!-- MultiStep Form -->
  <div class="container d-flex align-items-center" id="" style="height: 100vh">
    <div class="row justify-content-center mt-0">
      <div class="col-12 col-sm-9 col-md-7 col-lg-12 text-center p-2 p-md-0 mt-0 mb-0">
        <div class="card">
          <div class="row">
            <div class="col-md-12 mx-0">
              <form id="msform">
                <ul id="progressbar">
                  <li class="active relative" id="document">
                    <strong>ID Card Front</strong>
                    <div class="check-icon d-none">
                      <i class="fa fa-check-square-o" aria-hidden="true"></i>
                    </div>
                  </li>
                  <li id="document"><strong>ID Card Back</strong>
                    <div class="check-icon d-none">
                      <i class="fa fa-check-square-o" aria-hidden="true"></i>
                    </div>
                  </li>
                  <li id="selfie"><strong>Selfie</strong>
                    <div class="check-icon d-none">
                      <i class="fa fa-check-square-o" aria-hidden="true"></i>
                    </div>
                  </li>

                  <li id="confirm"><strong>Fingerprint</strong>
                    <div class="check-icon d-none">
                      <i class="fa fa-check-square-o" aria-hidden="true"></i>
                    </div>
                  </li>
                </ul>
                <div class="row justify-content-center mb-3">
                  <div class="col-12 text-center">
                    <p style="opacity: 0.7; margin-bottom: unset;">Step 1 of 4</p>
                  </div>
                </div>
                <fieldset>
                  <div class="form-card">
                    <h2 class="barlow-bold text-left" style="
                          font-size: 20px;
                          line-height: 30px;
                          font-weight: 600;
                          color: #1c2022;
                        ">
                      Front Side
                    </h2>
                    <p class="pg-text">
                      Upload your ID Card's front side. Please make sure that
                      the document is clear and readable.
                    </p>
                    <div class="box_btn">
                      <div id="cameraContainer" style="position: relative; overflow: hidden;">
                        <video id="videoFeed" autoplay playsinline style="width: 100%; height: auto;"></video>
                        <canvas id="overlayCanvas" style="position: absolute; top: 0; left: 0;"></canvas>
                        <button id="captureButton" class="btn btn-primary btn-sm">
                          Capture Image
                        </button>
                      </div>
                      <div class="previewContainer" id="previewContainer"></div>
                      <span class="error" style="color: red" id="error_cnic_document"></span>
                    </div>
                    <div class="retake_btn">
                      <button class="btn btn-danger btn-sm mt-2" style="display: none" id="retakebutton">
                        Retake
                      </button>
                      <button class="btn btn-primary btn-sm mt-2" style="display: none" id="next_step">
                        Next Step
                      </button>
                    </div>
                  </div>
                </fieldset>
              </form>

              <div class="modal fade" id="documentVerification" tabindex="-1" role="dialog" aria-labelledby="modalLabel"
                aria-hidden="true" data-keyboard="false" data-backdrop="static">
                <!DOCTYPE html>
                <html lang="en">

                <head>
                  <meta charset="UTF-8" />
                  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
                  <title>Document</title>
                  <link rel="stylesheet"
                    href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />

                  <link rel="stylesheet"
                    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css" />

                  <meta name="csrf-token" content="" />

                  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
                  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
                  <script src="{{ asset('assets/js/jquery.validate.min.js') }}"></script>
                </head>

                <body>
                  <div id="loader">
                    <div class="spinner"></div>
                    <p>Loading..</p>
                  </div>
                  <!-- MultiStep Form -->
                  <div class="container-fluid" id="">
                    <div class="row justify-content-center mt-0">
                      <div class="col-11 col-sm-9 col-md-7 col-lg-6 text-center p-0 mt-0 mb-0">
                        <div class="card px-0 pt-4 pb-0 mt-3 mb-3">
                          <h2><strong>Identity Verification</strong></h2>
                          <p>Please complete all steps to proceed.</p>
                          <div class="row">
                            <div class="col-md-12 mx-0">
                              <form id="msform">
                                <ul id="progressbar">
                                  <li class="active" id="document">
                                    <strong>ID Card</strong>
                                  </li>
                                  <li id="document">
                                    <strong>ID Card</strong>
                                  </li>
                                  <li id="selfie">
                                    <strong>Selfie</strong>
                                  </li>

                                  <li id="confirm">
                                    <strong>Fingerprint</strong>
                                  </li>
                                </ul>
                                <fieldset>
                                  <div class="form-card">
                                    <h4>Front Side</h4>
                                    <p>
                                      Upload your ID Card front side.please
                                      make sure that the document should be
                                      clear and readable.
                                    </p>
                                    <div class="box_btn">
                                      <div id="cameraContainer" style="position: relative; overflow: hidden;">
                                        <video id="videoFeed" style="position: absolute; top: 0; left: 0;"></video>
                                        <canvas id="overlayCanvas"
                                          style="position: absolute; top: 0; left: 0;"></canvas>
                                        <button id="captureButton" class="btn btn-primary btn-sm">
                                          Capture Image
                                        </button>
                                      </div>
                                      <div class="previewContainer" id="previewContainer"></div>
                                      <span class="error" style="color: red" id="error_cnic_document"></span>
                                    </div>
                                    <div class="retake_btn">
                                      <button class="btn btn-danger btn-sm mt-2" style="display: none"
                                        id="retakebutton">
                                        Retake
                                      </button>
                                      <button class="btn btn-primary btn-sm mt-2" style="display: none" id="next_step">
                                        Next Step
                                      </button>
                                    </div>
                                  </div>
                                </fieldset>
                              </form>

                              <div class="modal fade" id="documentVerification" tabindex="-1" role="dialog"
                                aria-labelledby="modalLabel" aria-hidden="true" data-keyboard="false"
                                data-backdrop="static">
                                <div class="modal-dialog modal-dialog modal-lg modal-dialog-mng">
                                  <div class="modal-content modal-content-first">
                                    <!-- Modal Header -->
                                    <div class="modal-header">
                                      <button type="button" class="close fa fa-times" data-dismiss="modal"></button>
                                    </div>
                                    <!-- Modal body -->
                                    <div class="modal-body">
                                      <div class="row">
                                        <div class="col-12">
                                          <form id="saveDocumentForm" action="" method="post"
                                            enctype="multipart/form-data">
                                            <input type="hidden" name="image_path" id="image_path" />
                                            <input type="hidden" name="token" value="" />

                                            <div class="modal-body">
                                              <p>
                                                If any mistakes occur while
                                                reading your ID card, you
                                                can make changes and click
                                                the save button.
                                              </p>
                                              <div class="row mt-3">
                                                <div class="col-6">
                                                  <div class="form-group">
                                                    <label for="identity_name">Name</label>
                                                    <input type="text" class="form-control" name="identity_name"
                                                      id="identity_name" />
                                                  </div>
                                                </div>
                                                <div class="col-6">
                                                  <div class="form-group">
                                                    <label for="">Father Name</label>
                                                    <input type="text" class="form-control" name="father_name"
                                                      id="father_name" />
                                                  </div>
                                                </div>
                                              </div>
                                              <div class="row mt-3">
                                                <div class="col-6">
                                                  <div class="form-group">
                                                    <label for="">Identity
                                                      Number</label>
                                                    <input type="text" class="form-control" name="identity_number"
                                                      id="identity_number" />
                                                  </div>
                                                </div>
                                                <div class="col-6">
                                                  <div class="form-group">
                                                    <label for="">Date of Birth
                                                      (dd-mm-yyyy)</label>
                                                    <input type="text" class="form-control" name="date_of_birth"
                                                      id="date_of_birth" />
                                                  </div>
                                                </div>
                                              </div>
                                              <div class="row mt-3">
                                                <div class="col-6">
                                                  <div class="form-group">
                                                    <label for="">Card issuenes Date
                                                      (dd-mm-yyyy)</label>
                                                    <input type="text" class="form-control" name="card_issue_date"
                                                      id="card_issue_date" />
                                                  </div>
                                                </div>
                                                <div class="col-6">
                                                  <div class="form-group">
                                                    <label for="">Card Expiry Date
                                                      (dd-mm-yyyy)</label>
                                                    <input type="text" class="form-control" name="card_expiry_date"
                                                      id="card_expiry_date" />
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                            <div class="modal-footer" style="
                                                    display: block;
                                                    padding-top: 20px;
                                                  ">
                                              <button type="button" data-dismiss="modal" class="btn btn-sm btn-danger">
                                                Close
                                              </button>
                                              <button type="submit" class="btn btn-sm btn-success">
                                                Next
                                              </button>
                                            </div>
                                          </form>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="modal fade" id="missingDataAlert" data-bs-backdrop="static"
                                data-bs-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="modalLabel"
                                aria-hidden="true" data-keyboard="false" data-backdrop="static">
                                <div class="modal-dialog modal-dialog modal-lg modal-dialog-mng">
                                  <div class="modal-content modal-content-first">
                                    <!-- Modal Header -->
                                    <div class="modal-header">
                                      <h5 class="modal-title" id="modalLabel">
                                        Missing Data Alert
                                      </h5>
                                      <!-- Modal title -->
                                      <button type="button" class="close fa fa-times" data-dismiss="modal"></button>
                                    </div>
                                    <!-- Modal body -->
                                    <div class="modal-body">
                                      <p id="error_cnic_document_modal"></p>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-danger" data-dismiss="modal">
                                        Ok
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <script>
                    $(document).ready(function () {
                      $(".submit").click(function () {
                        return false;
                      });
                      hideLoader();
                    });

                    function hideLoader() {
                      document.getElementById("loader").style.display =
                        "none";
                      document.getElementById("msform").style.display =
                        "block";
                    }

                    function showLoader() {
                      document.getElementById("loader").style.display =
                        "flex";
                      document.getElementById("msform").style.display =
                        "none";
                    }
                  </script>
                </body>

                </html>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Move this script to the end of the body -->
  <script>
    const video = document.getElementById("videoFeed");
    const previewContainer = document.getElementById("previewContainer");
    const overlayCanvas = document.getElementById("overlayCanvas");
    const captureButton = document.getElementById("captureButton");
    const overlayCtx = overlayCanvas.getContext("2d");

    async function initializeCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment",
            width: { ideal: 1280 },
            height: { ideal: 720 },
          },
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          drawBox();
        };
      } catch (error) {
        console.error("Error accessing camera:", error);
        alert("Camera access failed. Please ensure you've granted camera permissions and try again.");
      }
    }

    function drawBox() {
      const frameWidth = video.videoWidth;
      const frameHeight = video.videoHeight;
      const boxWidth = 350;
      const boxHeight = 467;
      const borderRadius = 10;

      const boxX = (frameWidth - boxWidth) / 2;
      const boxY = (frameHeight - boxHeight) / 2;

      overlayCanvas.width = frameWidth;
      overlayCanvas.height = frameHeight;

      overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      overlayCtx.strokeStyle = "#CCFF00";
      overlayCtx.lineWidth = 4;

      drawRoundedRect(overlayCtx, boxX, boxY, boxWidth, boxHeight, borderRadius);
    }

    function drawRoundedRect(ctx, x, y, width, height, radius) {
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + width - radius, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      ctx.lineTo(x + width, y + height - radius);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
      ctx.lineTo(x + radius, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();
      ctx.stroke();
    }

    // Initialize camera when the page loads
    document.addEventListener('DOMContentLoaded', initializeCamera);

    // Capture image when the button is clicked
    captureButton.addEventListener("click", captureImage);

    function captureImage() {
      // ... (rest of the captureImage function)
    }

    // ... (rest of your JavaScript code)
  </script>
</body>

</html>