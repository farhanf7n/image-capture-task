<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Step - 1</title>

    <!-- Google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- Custom css -->
    <link rel="stylesheet" href="style.css" />

    <!-- Bootstrap css  -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />

    <!-- Font awesome css  -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css"
    />

    <meta name="csrf-token" content="" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="{{ asset('assets/js/jquery.validate.min.js') }}"></script>
  </head>

  <body>
    <div id="loader">
      <div class="spinner"></div>
      <p>Loading..</p>
    </div>
    <!-- MultiStep Form -->
    <div
      class="container d-flex align-items-center"
      id=""
      style="height: 100vh"
    >
      <div class="row justify-content-center my-5">
        <div
          class="col-12 col-sm-9 col-md-7 col-lg-12 text-center p-2 p-md-0 mt-0 mb-0"
        >
          <div class="card">
            <div class="row">
              <div class="col-md-12 mx-0">
                <form id="msform">
                  <ul id="progressbar">
                    <li class="active relative" id="document">
                      <strong>ID Card Front</strong>
                      <div class="check-icon d-none">
                        <i class="fa fa-check-square-o" aria-hidden="true"></i>
                      </div>
                    </li>
                    <li id="document">
                      <strong>ID Card Back</strong>
                      <div class="check-icon d-none">
                        <i class="fa fa-check-square-o" aria-hidden="true"></i>
                      </div>
                    </li>
                    <li id="selfie">
                      <strong>Selfie</strong>
                      <div class="check-icon d-none">
                        <i class="fa fa-check-square-o" aria-hidden="true"></i>
                      </div>
                    </li>

                    <li id="confirm">
                      <strong>Fingerprint</strong>
                      <div class="check-icon d-none">
                        <i class="fa fa-check-square-o" aria-hidden="true"></i>
                      </div>
                    </li>
                  </ul>
                  <div
                    class="row justify-content-center"
                    style="margin-bottom: 16px"
                  >
                    <div class="col-12 text-center">
                      <p style="opacity: 0.7; margin-bottom: unset">
                        Step 1 of 4
                      </p>
                    </div>
                  </div>
                  <fieldset>
                    <div class="form-card">
                      <h2
                        class="barlow-bold text-left"
                        style="
                          font-size: 20px;
                          line-height: 30px;
                          font-weight: 600;
                          color: #1c2022;
                        "
                      >
                        Front Side
                      </h2>
                      <p class="pg-text">
                        Upload your ID Card's front side. Please make sure that
                        the document is clear and readable.
                      </p>
                      <div class="box_btn">
                        <div id="cameraContainer">
                          <video id="videoFeed" autoplay playsinline></video>
                          <canvas id="overlayCanvas"></canvas>
                          <button
                            id="captureButton"
                            class="btn btn-primary btn-sm"
                          >
                            Capture Image
                          </button>
                        </div>
                        <div
                          class="previewContainer"
                          id="previewContainer"
                        ></div>
                        <span
                          class="error"
                          style="color: red"
                          id="error_cnic_document"
                        ></span>
                      </div>
                      <div class="retake_btn">
                        <button
                          class="btn btn-danger btn-sm mt-2"
                          style="display: none"
                          id="retakebutton"
                        >
                          Retake
                        </button>
                        <button
                          class="btn btn-primary btn-sm mt-2"
                          style="display: none"
                          id="next_step"
                        >
                          Next Step
                        </button>
                      </div>
                    </div>
                  </fieldset>
                </form>

                <div
                  class="modal fade"
                  id="documentVerification"
                  tabindex="-1"
                  role="dialog"
                  aria-labelledby="modalLabel"
                  aria-hidden="true"
                  data-keyboard="false"
                  data-backdrop="static"
                >
                  <!DOCTYPE html>
                  <html lang="en">
                    <head>
                      <meta charset="UTF-8" />
                      <meta
                        name="viewport"
                        content="width=device-width, initial-scale=1.0"
                      />
                      <meta http-equiv="X-UA-Compatible" content="ie=edge" />
                      <title>Document</title>
                      <link
                        rel="stylesheet"
                        href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
                      />

                      <link
                        rel="stylesheet"
                        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css"
                      />

                      <meta name="csrf-token" content="" />

                      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
                      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
                      <script src="{{ asset('assets/js/jquery.validate.min.js') }}"></script>
                    </head>

                    <body>
                      <div id="loader">
                        <div class="spinner"></div>
                        <p>Loading..</p>
                      </div>
                      <!-- MultiStep Form -->
                      <div class="container-fluid" id="">
                        <div class="row justify-content-center mt-0">
                          <div
                            class="col-11 col-sm-9 col-md-7 col-lg-6 text-center p-0 mt-0 mb-0"
                          >
                            <div class="card px-0 pt-4 pb-0 mt-3 mb-3">
                              <h2><strong>Identity Verification</strong></h2>
                              <p>Please complete all steps to proceed.</p>
                              <div class="row">
                                <div class="col-md-12 mx-0">
                                  <form id="msform">
                                    <ul id="progressbar">
                                      <li class="active" id="document">
                                        <strong>ID Card</strong>
                                      </li>
                                      <li id="document">
                                        <strong>ID Card</strong>
                                      </li>
                                      <li id="selfie">
                                        <strong>Selfie</strong>
                                      </li>

                                      <li id="confirm">
                                        <strong>Fingerprint</strong>
                                      </li>
                                    </ul>
                                    <fieldset>
                                      <div class="form-card">
                                        <h4>Front Side</h4>
                                        <p>
                                          Upload your ID Card front side.please
                                          make sure that the document should be
                                          clear and readable.
                                        </p>
                                        <div class="box_btn">
                                          <div id="cameraContainer">
                                            <video
                                              id="videoFeed"
                                              autoplay
                                              playsinline
                                            ></video>
                                            <canvas id="overlayCanvas"></canvas>
                                            <button
                                              id="captureButton"
                                              class="btn btn-primary btn-sm"
                                            >
                                              Capture Image
                                            </button>
                                          </div>
                                          <div
                                            class="previewContainer"
                                            id="previewContainer"
                                          ></div>
                                          <span
                                            class="error"
                                            style="color: red"
                                            id="error_cnic_document"
                                          ></span>
                                        </div>
                                        <div class="retake_btn">
                                          <button
                                            class="btn btn-danger btn-sm mt-2"
                                            style="display: none"
                                            id="retakebutton"
                                          >
                                            Retake
                                          </button>
                                          <button
                                            class="btn btn-primary btn-sm mt-2"
                                            style="display: none"
                                            id="next_step"
                                          >
                                            Next Step
                                          </button>
                                        </div>
                                      </div>
                                    </fieldset>
                                  </form>

                                  <div
                                    class="modal fade"
                                    id="documentVerification"
                                    tabindex="-1"
                                    role="dialog"
                                    aria-labelledby="modalLabel"
                                    aria-hidden="true"
                                    data-keyboard="false"
                                    data-backdrop="static"
                                  >
                                    <div
                                      class="modal-dialog modal-dialog modal-lg modal-dialog-mng"
                                    >
                                      <div
                                        class="modal-content modal-content-first"
                                      >
                                        <!-- Modal Header -->
                                        <div class="modal-header">
                                          <button
                                            type="button"
                                            class="close fa fa-times"
                                            data-dismiss="modal"
                                          ></button>
                                        </div>
                                        <!-- Modal body -->
                                        <div class="modal-body">
                                          <div class="row">
                                            <div class="col-12">
                                              <form
                                                id="saveDocumentForm"
                                                action=""
                                                method="post"
                                                enctype="multipart/form-data"
                                              >
                                                <input
                                                  type="hidden"
                                                  name="image_path"
                                                  id="image_path"
                                                />
                                                <input
                                                  type="hidden"
                                                  name="token"
                                                  value=""
                                                />

                                                <div class="modal-body">
                                                  <p>
                                                    If any mistakes occur while
                                                    reading your ID card, you
                                                    can make changes and click
                                                    the save button.
                                                  </p>
                                                  <div class="row mt-3">
                                                    <div class="col-6">
                                                      <div class="form-group">
                                                        <label
                                                          for="identity_name"
                                                          >Name</label
                                                        >
                                                        <input
                                                          type="text"
                                                          class="form-control"
                                                          name="identity_name"
                                                          id="identity_name"
                                                        />
                                                      </div>
                                                    </div>
                                                    <div class="col-6">
                                                      <div class="form-group">
                                                        <label for=""
                                                          >Father Name</label
                                                        >
                                                        <input
                                                          type="text"
                                                          class="form-control"
                                                          name="father_name"
                                                          id="father_name"
                                                        />
                                                      </div>
                                                    </div>
                                                  </div>
                                                  <div class="row mt-3">
                                                    <div class="col-6">
                                                      <div class="form-group">
                                                        <label for=""
                                                          >Identity
                                                          Number</label
                                                        >
                                                        <input
                                                          type="text"
                                                          class="form-control"
                                                          name="identity_number"
                                                          id="identity_number"
                                                        />
                                                      </div>
                                                    </div>
                                                    <div class="col-6">
                                                      <div class="form-group">
                                                        <label for=""
                                                          >Date of Birth
                                                          (dd-mm-yyyy)</label
                                                        >
                                                        <input
                                                          type="text"
                                                          class="form-control"
                                                          name="date_of_birth"
                                                          id="date_of_birth"
                                                        />
                                                      </div>
                                                    </div>
                                                  </div>
                                                  <div class="row mt-3">
                                                    <div class="col-6">
                                                      <div class="form-group">
                                                        <label for=""
                                                          >Card issuenes Date
                                                          (dd-mm-yyyy)</label
                                                        >
                                                        <input
                                                          type="text"
                                                          class="form-control"
                                                          name="card_issue_date"
                                                          id="card_issue_date"
                                                        />
                                                      </div>
                                                    </div>
                                                    <div class="col-6">
                                                      <div class="form-group">
                                                        <label for=""
                                                          >Card Expiry Date
                                                          (dd-mm-yyyy)</label
                                                        >
                                                        <input
                                                          type="text"
                                                          class="form-control"
                                                          name="card_expiry_date"
                                                          id="card_expiry_date"
                                                        />
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                                <div
                                                  class="modal-footer"
                                                  style="
                                                    display: block;
                                                    padding-top: 20px;
                                                  "
                                                >
                                                  <button
                                                    type="button"
                                                    data-dismiss="modal"
                                                    class="btn btn-sm btn-danger"
                                                  >
                                                    Close
                                                  </button>
                                                  <button
                                                    type="submit"
                                                    class="btn btn-sm btn-success"
                                                  >
                                                    Next
                                                  </button>
                                                </div>
                                              </form>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                  <div
                                    class="modal fade"
                                    id="missingDataAlert"
                                    data-bs-backdrop="static"
                                    data-bs-keyboard="false"
                                    tabindex="-1"
                                    role="dialog"
                                    aria-labelledby="modalLabel"
                                    aria-hidden="true"
                                    data-keyboard="false"
                                    data-backdrop="static"
                                  >
                                    <div
                                      class="modal-dialog modal-dialog modal-lg modal-dialog-mng"
                                    >
                                      <div
                                        class="modal-content modal-content-first"
                                      >
                                        <!-- Modal Header -->
                                        <div class="modal-header">
                                          <h5
                                            class="modal-title"
                                            id="modalLabel"
                                          >
                                            Missing Data Alert
                                          </h5>
                                          <!-- Modal title -->
                                          <button
                                            type="button"
                                            class="close fa fa-times"
                                            data-dismiss="modal"
                                          ></button>
                                        </div>
                                        <!-- Modal body -->
                                        <div class="modal-body">
                                          <p id="error_cnic_document_modal"></p>
                                        </div>
                                        <div class="modal-footer">
                                          <button
                                            type="button"
                                            class="btn btn-danger"
                                            data-dismiss="modal"
                                          >
                                            Ok
                                          </button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <script>
                                    const video =
                                      document.getElementById("videoFeed");
                                    const previewContainer =
                                      document.getElementById(
                                        "previewContainer"
                                      );

                                    const overlayCanvas =
                                      document.getElementById("overlayCanvas");
                                    const captureButton =
                                      document.getElementById("captureButton");
                                    const overlayCtx =
                                      overlayCanvas.getContext("2d");

                                    // Function to draw a box border on the overlay canvas
                                    function drawBox() {
                                      const frameWidth =
                                        video.videoWidth || 300; // Use video width if available, else fallback to 300
                                      const frameHeight =
                                        video.videoHeight || 200; // Use video height if available, else fallback to 200
                                      const boxWidth = frameWidth * 0.8; // 80% of frame width
                                      const boxHeight = frameHeight * 0.8; // 80% of frame height
                                      const borderRadius = 2; // Border radius

                                      const boxX = (frameWidth - boxWidth) / 2; // Calculate X position of the box
                                      const boxY =
                                        (frameHeight - boxHeight) / 2; // Calculate Y position of the box

                                      // Set the size of the overlay canvas
                                      overlayCanvas.width = frameWidth;
                                      overlayCanvas.height = frameHeight;

                                      // Clear the overlay canvas
                                      overlayCtx.clearRect(
                                        0,
                                        0,
                                        overlayCanvas.width,
                                        overlayCanvas.height
                                      );

                                      // Draw the rounded box on the overlay canvas
                                      overlayCtx.strokeStyle = "#CCFF00";
                                      overlayCtx.lineWidth = 4;

                                      // Function to draw rounded rectangle
                                      drawRoundedRect(
                                        overlayCtx,
                                        boxX,
                                        boxY,
                                        boxWidth,
                                        boxHeight,
                                        borderRadius
                                      );
                                    }

                                    function drawRoundedRect(
                                      ctx,
                                      x,
                                      y,
                                      width,
                                      height,
                                      radius
                                    ) {
                                      ctx.beginPath();
                                      ctx.moveTo(x + radius, y);
                                      ctx.lineTo(x + width - radius, y);
                                      ctx.quadraticCurveTo(
                                        x + width,
                                        y,
                                        x + width,
                                        y + radius
                                      );
                                      ctx.lineTo(
                                        x + width,
                                        y + height - radius
                                      );
                                      ctx.quadraticCurveTo(
                                        x + width,
                                        y + height,
                                        x + width - radius,
                                        y + height
                                      );
                                      ctx.lineTo(x + radius, y + height);
                                      ctx.quadraticCurveTo(
                                        x,
                                        y + height,
                                        x,
                                        y + height - radius
                                      );
                                      ctx.lineTo(x, y + radius);
                                      ctx.quadraticCurveTo(x, y, x + radius, y);
                                      ctx.closePath();
                                      ctx.stroke();
                                    }

                                    // Call drawBox initially to show the box
                                    drawBox();

                                    // Add this line to redraw the box when the video dimensions are known
                                    video.addEventListener(
                                      "loadedmetadata",
                                      drawBox
                                    );

                                    async function initializeCamera() {
                                      try {
                                        const stream =
                                          await navigator.mediaDevices.getUserMedia(
                                            {
                                              video: {
                                                facingMode: "environment",
                                                width: { ideal: 1280 },
                                                height: { ideal: 720 },
                                                frameRate: { ideal: 30 },
                                              },
                                            }
                                          );
                                        video.srcObject = stream;
                                        await video.play();
                                      } catch (error) {
                                        console.error(
                                          "Error accessing camera:",
                                          error
                                        );
                                      }
                                    }
                                    initializeCamera(); // 'environment' for back camera
                                    // Capture image when the button is clicked
                                    captureButton.addEventListener(
                                      "click",
                                      () => {
                                        captureImage();
                                        // Perform image capture logic here
                                      }
                                    );
                                    var captured_image;

                                    function captureImage() {
                                      $("#cameraContainer").hide();
                                      const canvas =
                                        document.createElement("canvas");
                                      const ctx = canvas.getContext("2d");

                                      // Set canvas size to a smaller, fixed size
                                      const targetWidth = 1280; // Adjust this value as needed
                                      const targetHeight =
                                        (video.videoHeight / video.videoWidth) *
                                        targetWidth;

                                      canvas.width = targetWidth;
                                      canvas.height = targetHeight;

                                      // Draw the video frame onto the canvas, scaling it down
                                      ctx.drawImage(
                                        video,
                                        0,
                                        0,
                                        targetWidth,
                                        targetHeight
                                      );

                                      // Apply a subtle sharpening filter (optional, remove if it's too slow)
                                      applySharpening(
                                        ctx,
                                        targetWidth,
                                        targetHeight
                                      );

                                      // Convert to JPEG with reduced quality
                                      const imageDataURL = canvas.toDataURL(
                                        "image/jpeg",
                                        0.85
                                      ); // Adjust quality (0.85 = 85%) as needed

                                      // Create image element and set source
                                      const img = new Image();
                                      img.onload = function () {
                                        // Clear previous content and append new image
                                        previewContainer.innerHTML = "";
                                        previewContainer.appendChild(img);
                                        $("#previewContainer").show();
                                        $("#retakebutton").show();
                                        $("#next_step").show();

                                        // Show the check icon for ID Card Front
                                        $(
                                          "#progressbar li:first-child .check-icon"
                                        ).removeClass("d-none");
                                      };
                                      img.src = imageDataURL;
                                      captured_image = imageDataURL;
                                    }

                                    function applySharpening(
                                      ctx,
                                      width,
                                      height
                                    ) {
                                      const imageData = ctx.getImageData(
                                        0,
                                        0,
                                        width,
                                        height
                                      );
                                      const data = imageData.data;
                                      const factor = 0.5; // Adjust this value to control sharpening intensity

                                      for (let y = 1; y < height - 1; y++) {
                                        for (let x = 1; x < width - 1; x++) {
                                          const idx = (y * width + x) * 4;
                                          for (let c = 0; c < 3; c++) {
                                            const val =
                                              5 * data[idx + c] -
                                              data[idx - 4 + c] -
                                              data[idx + 4 + c] -
                                              data[idx - width * 4 + c] -
                                              data[idx + width * 4 + c];
                                            data[idx + c] = Math.min(
                                              255,
                                              Math.max(
                                                0,
                                                data[idx + c] +
                                                  factor * (val - data[idx + c])
                                              )
                                            );
                                          }
                                        }
                                      }

                                      ctx.putImageData(imageData, 0, 0);
                                    }
                                    $("#msform").on("submit", function (e) {
                                      e.preventDefault();
                                    });
                                    $("#retakebutton").on(
                                      "click",
                                      function (e) {
                                        e.preventDefault();
                                        $("#cameraContainer").show();
                                        $("#previewContainer").hide();
                                        $(this).hide();
                                        $("#next_step").hide();
                                        $("#error_cnic_document").text("");
                                      }
                                    );

                                    $("#next_step").on("click", function (e) {
                                      e.preventDefault();
                                      // Save the progress in localStorage
                                      localStorage.setItem(
                                        "step1Completed",
                                        "true"
                                      );
                                      // Redirect to step2.html
                                      window.location.href = "step2.html";
                                    });

                                    $.validator.addMethod(
                                      "customDate",
                                      function (value, element) {
                                        // Check if the value matches the "d-m-Y" format using a regular expression
                                        return /^(0?[1-9]|[12][0-9]|3[01])-(0?[1-9]|1[012])-\d{4}$/.test(
                                          value
                                        );
                                      },
                                      "Please enter a valid date (dd-mm-yyyy)"
                                    );
                                    $("#saveDocumentForm").validate({
                                      rules: {
                                        identity_name: {
                                          required: true,
                                        },
                                        father_name: {
                                          required: true,
                                        },
                                        identity_number: {
                                          required: true,
                                          minlength: 13,
                                          maxlength: 13,
                                          number: true,
                                        },
                                        date_of_birth: {
                                          required: true,
                                          customDate: true,
                                        },
                                        card_issue_date: {
                                          required: true,
                                          customDate: true,
                                        },
                                        card_expiry_date: {
                                          required: true,
                                          customDate: true,
                                        },
                                      },
                                      messages: {
                                        date_of_birth: {
                                          dateISO:
                                            "Enter a valid date in format (1998-10-04).",
                                        },
                                        card_issue_date: {
                                          dateISO:
                                            "Enter a valid date in format (1998-10-04).",
                                        },
                                        card_expiry_date: {
                                          dateISO:
                                            "Enter a valid date in format (1998-10-04).",
                                        },

                                        identity_number: {
                                          number:
                                            "Put only numbers of your id card.",
                                          minlength:
                                            "The ID card number must be exactly 13 characters long.",
                                          maxlength:
                                            "The ID card number must be exactly 13 characters long.",
                                        },
                                      },
                                      errorPlacement: function (
                                        error,
                                        element
                                      ) {
                                        error.insertAfter(element);
                                        //   error.appendTo(element.parent());
                                      },
                                      submitHandler: function (form) {
                                        form.submit();
                                      },
                                    });
                                  </script>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <script>
                        $(document).ready(function () {
                          $(".submit").click(function () {
                            return false;
                          });
                          hideLoader();
                        });

                        function hideLoader() {
                          document.getElementById("loader").style.display =
                            "none";
                          document.getElementById("msform").style.display =
                            "block";
                        }

                        function showLoader() {
                          document.getElementById("loader").style.display =
                            "flex";
                          document.getElementById("msform").style.display =
                            "none";
                        }
                      </script>
                    </body>
                  </html>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
