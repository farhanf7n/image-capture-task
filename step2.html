<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Step - 2</title>

    <!-- Bootstrap css  -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />

    <!-- Font awesome css  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css" />

    <!-- Custom css -->
    <link rel="stylesheet" href="style.css" />

    <!-- Google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet" />

    <meta name="csrf-token" content="" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div id="loader">
        <div class="spinner"></div>
        <p>Loading..</p>
    </div>
    <!-- MultiStep Form -->
    <div class="container d-flex align-items-center" style="min-height: 100vh" id="">
        <div class="row justify-content-center">
            <div class="col-12 col-sm-9 col-md-7 col-lg-6 text-center p-2 p-md-0 mt-0 mb-0">
                <div class="card">
                    <div class="row">
                        <div class="col-md-12 mx-0">
                            <form id="msform">
                                <ul id="progressbar">
                                    <li class="active relative" id="document">
                                        <strong>ID Card Front</strong>
                                        <div class="check-icon d-none">
                                            <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                        </div>
                                    </li>
                                    <li id="document"><strong>ID Card Back</strong>
                                        <div class="check-icon d-none">
                                            <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                        </div>
                                    </li>
                                    <li id="selfie"><strong>Selfie</strong>
                                        <div class="check-icon d-none">
                                            <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                        </div>
                                    </li>

                                    <li id="confirm"><strong>Fingerprint</strong>
                                        <div class="check-icon d-none">
                                            <i class="fa fa-check-square-o" aria-hidden="true"></i>
                                        </div>
                                    </li>
                                </ul>
                                <div class="row justify-content-center" style="margin-bottom: 16px;">
                                    <div class="col-12 text-center">
                                        <p style="opacity: 0.7; margin-bottom: unset;">Step 2 of 4</p>
                                    </div>
                                </div>
                                <fieldset>
                                    <div class="form-card">
                                        <h2 class="barlow-bold text-left" style="
                          font-size: 20px;
                          line-height: 30px;
                          font-weight: 600;
                          color: #1c2022;
                        ">Back Side</h2>
                                        <p class="pg-text">
                                            Upload your ID Card's back side. Please make sure that the document is clear
                                            and readable.
                                        </p>
                                        <div id="cameraContainer">
                                            <video id="videoFeed" autoplay playsinline></video>
                                            <canvas id="overlayCanvas"></canvas>
                                            <button id="captureButton" class="btn btn-primary btn-sm">
                                                Capture Image
                                            </button>
                                        </div>
                                        <div class="previewContainer" id="previewContainer"></div>
                                        <div id="loadingIndicator" style="display: none;">
                                            <div class="spinner-border" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </div>
                                        <span class="error" style="color: red" id="error_cnic_document"></span>
                                        <div class="retake_btn">
                                            <button class="btn btn-danger btn-sm mt-2" style="display: none"
                                                id="retakebutton">
                                                Retake
                                            </button>
                                            <button class="btn btn-primary btn-sm mt-2" style="display: none"
                                                id="next_step">
                                                Next Step
                                            </button>
                                        </div>
                                    </div>

                                </fieldset>
                            </form>

                            <script>
                                const video =
                                    document.getElementById("videoFeed");
                                const previewContainer =
                                    document.getElementById(
                                        "previewContainer"
                                    );

                                const overlayCanvas =
                                    document.getElementById("overlayCanvas");
                                const captureButton =
                                    document.getElementById("captureButton");
                                const overlayCtx =
                                    overlayCanvas.getContext("2d");

                                // Function to draw a box border on the overlay canvas
                                function drawBox() {
                                    const frameWidth =
                                        video.videoWidth || 300; // Use video width if available, else fallback to 300
                                    const frameHeight =
                                        video.videoHeight || 200; // Use video height if available, else fallback to 200
                                    const boxWidth = frameWidth * 0.8; // 80% of frame width
                                    const boxHeight = frameHeight * 0.8; // 80% of frame height
                                    const borderRadius = 2; // Border radius

                                    const boxX = (frameWidth - boxWidth) / 2; // Calculate X position of the box
                                    const boxY =
                                        (frameHeight - boxHeight) / 2; // Calculate Y position of the box

                                    // Set the size of the overlay canvas
                                    overlayCanvas.width = frameWidth;
                                    overlayCanvas.height = frameHeight;

                                    // Clear the overlay canvas
                                    overlayCtx.clearRect(
                                        0,
                                        0,
                                        overlayCanvas.width,
                                        overlayCanvas.height
                                    );

                                    // Draw the rounded box on the overlay canvas
                                    overlayCtx.strokeStyle = "#CCFF00";
                                    overlayCtx.lineWidth = 4;

                                    // Function to draw rounded rectangle
                                    drawRoundedRect(
                                        overlayCtx,
                                        boxX,
                                        boxY,
                                        boxWidth,
                                        boxHeight,
                                        borderRadius
                                    );
                                }

                                function drawRoundedRect(
                                    ctx,
                                    x,
                                    y,
                                    width,
                                    height,
                                    radius
                                ) {
                                    ctx.beginPath();
                                    ctx.moveTo(x + radius, y);
                                    ctx.lineTo(x + width - radius, y);
                                    ctx.quadraticCurveTo(
                                        x + width,
                                        y,
                                        x + width,
                                        y + radius
                                    );
                                    ctx.lineTo(
                                        x + width,
                                        y + height - radius
                                    );
                                    ctx.quadraticCurveTo(
                                        x + width,
                                        y + height,
                                        x + width - radius,
                                        y + height
                                    );
                                    ctx.lineTo(x + radius, y + height);
                                    ctx.quadraticCurveTo(
                                        x,
                                        y + height,
                                        x,
                                        y + height - radius
                                    );
                                    ctx.lineTo(x, y + radius);
                                    ctx.quadraticCurveTo(x, y, x + radius, y);
                                    ctx.closePath();
                                    ctx.stroke();
                                }

                                // Call drawBox initially to show the box
                                drawBox();

                                // Add this line to redraw the box when the video dimensions are known
                                video.addEventListener(
                                    "loadedmetadata",
                                    drawBox
                                );

                                // Add this function at the beginning of your script
                                function initializeCameraOnLoad() {
                                    if (document.readyState === "complete") {
                                        initializeCamera();
                                    } else {
                                        window.addEventListener('load', initializeCamera);
                                    }
                                }

                                // Modify the initializeCamera function to return the stream
                                async function initializeCamera() {
                                    try {
                                        const stream = await navigator.mediaDevices.getUserMedia({
                                            video: {
                                                facingMode: "environment",
                                                width: { ideal: 1920 },
                                                height: { ideal: 1080 },
                                                frameRate: { ideal: 30 },
                                            },
                                        });
                                        video.srcObject = stream;
                                        await video.play();
                                        drawBox(); // Call drawBox after the video starts playing
                                        return stream; // Return the stream
                                    } catch (error) {
                                        console.error("Error accessing camera:", error);
                                    }
                                }

                                // Store the current stream
                                let currentStream;

                                // Initialize camera and store the stream
                                initializeCameraOnLoad();

                                // Capture image when the button is clicked
                                captureButton.addEventListener(
                                    "click",
                                    () => {
                                        captureImage();
                                        // Perform image capture logic here
                                    }
                                );
                                var captured_image;

                                // Modify the captureImage function to use currentStream
                                function captureImage() {
                                    $("#cameraContainer").hide();
                                    $("#loadingIndicator").show();

                                    const canvas = document.createElement("canvas");
                                    const ctx = canvas.getContext("2d");
                                    canvas.width = video.videoWidth;
                                    canvas.height = video.videoHeight;

                                    createImageBitmap(video).then(bitmap => {
                                        ctx.drawImage(bitmap, 0, 0);
                                        const imageDataURL = canvas.toDataURL('image/png');

                                        const img = new Image();
                                        img.onload = function () {
                                            previewContainer.innerHTML = '';
                                            previewContainer.appendChild(img);
                                            $("#previewContainer").show();
                                            $("#retakebutton").show();
                                            $("#next_step").show();

                                            // Show the check icon for ID Card Back
                                            $('#progressbar li:nth-child(2) .check-icon').removeClass('d-none');
                                            $("#loadingIndicator").hide();
                                        };
                                        img.src = imageDataURL;
                                        captured_image = imageDataURL;

                                        // Stop the video stream
                                        if (currentStream) {
                                            currentStream.getTracks().forEach(track => track.stop());
                                        }
                                    });
                                }

                                $("#msform").on("submit", function (e) {
                                    e.preventDefault();
                                });
                                // Modify the retake button click handler
                                $("#retakebutton").on("click", function (e) {
                                    e.preventDefault();
                                    $("#cameraContainer").show();
                                    $("#previewContainer").hide();
                                    $(this).hide();
                                    $("#next_step").hide();
                                    $("#error_cnic_document").text("");
                                    $('#progressbar li:nth-child(2) .check-icon').addClass('d-none');

                                    // Stop the current stream if it exists
                                    if (currentStream) {
                                        currentStream.getTracks().forEach(track => track.stop());
                                    }

                                    // Reinitialize the camera
                                    initializeCamera().then(stream => {
                                        currentStream = stream;
                                    });
                                });

                                $("#next_step").on("click", function (e) {
                                    e.preventDefault();
                                    // Save the progress in localStorage
                                    localStorage.setItem('step2Completed', 'true');
                                    // Redirect to step3.html
                                    window.location.href = "step3.html";
                                });

                                $.validator.addMethod(
                                    "customDate",
                                    function (value, element) {
                                        // Check if the value matches the "d-m-Y" format using a regular expression
                                        return /^(0?[1-9]|[12][0-9]|3[01])-(0?[1-9]|1[012])-\d{4}$/.test(
                                            value
                                        );
                                    },
                                    "Please enter a valid date (dd-mm-yyyy)"
                                );
                                $("#saveDocumentForm").validate({
                                    rules: {
                                        identity_name: {
                                            required: true,
                                        },
                                        father_name: {
                                            required: true,
                                        },
                                        identity_number: {
                                            required: true,
                                            minlength: 13,
                                            maxlength: 13,
                                            number: true,
                                        },
                                        date_of_birth: {
                                            required: true,
                                            customDate: true,
                                        },
                                        card_issue_date: {
                                            required: true,
                                            customDate: true,
                                        },
                                        card_expiry_date: {
                                            required: true,
                                            customDate: true,
                                        },
                                    },
                                    messages: {
                                        date_of_birth: {
                                            dateISO:
                                                "Enter a valid date in format (1998-10-04).",
                                        },
                                        card_issue_date: {
                                            dateISO:
                                                "Enter a valid date in format (1998-10-04).",
                                        },
                                        card_expiry_date: {
                                            dateISO:
                                                "Enter a valid date in format (1998-10-04).",
                                        },

                                        identity_number: {
                                            number:
                                                "Put only numbers of your id card.",
                                            minlength:
                                                "The ID card number must be exactly 13 characters long.",
                                            maxlength:
                                                "The ID card number must be exactly 13 characters long.",
                                        },
                                    },
                                    errorPlacement: function (
                                        error,
                                        element
                                    ) {
                                        error.insertAfter(element);
                                        //   error.appendTo(element.parent());
                                    },
                                    submitHandler: function (form) {
                                        form.submit();
                                    },
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>

    <script>
        $(document).ready(function () {
            $(".submit").click(function () {
                return false;
            });
            hideLoader();
        });

        function hideLoader() {
            document.getElementById("loader").style.display = "none";
            document.getElementById("msform").style.display = "block";
        }

        function showLoader() {
            document.getElementById("loader").style.display = "flex";
            document.getElementById("msform").style.display = "none";
        }

        // Check if step 1 was completed
        if (localStorage.getItem('step1Completed') === 'true') {
            // Keep ID Card Front active and checked
            $('#progressbar li:first-child').addClass('active');
            $('#progressbar li:first-child .check-icon').removeClass('d-none');

            // Make ID Card Back active
            $('#progressbar li:nth-child(2)').addClass('active');
        }
    </script>
</body>

</html>